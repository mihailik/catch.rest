<!DOCTYPE html>
<html lang="en" style="width: 100%; height: 100%; overflow: hidden; padding: 0; margin: 0;">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>TTY</title>
</head>
<body style="width: 100%; height: 100%; overflow: hidden; padding: 0; margin: 0;">
<textarea id="textarea" style="
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  overflow: auto;
  border: none;
  padding: 1em;
  outline: none;
  font: inherit;
  padding-top: 3em;" autofocus>
</textarea>
<style>
#toolbar button {
  width: 1.7em; height: 1.7em; margin: 0.15em;
}  
</style>
<div id="toolbar" style="
  position: absolute; top: 0; left: 0; width: 100%;
  background: whitesmoke;
">
<button id="bold">𝗕</button>
<button id="italic">𝘐</button>
<button id="fractur">𝕱</button>
<button id="cursive">𝓒</button>
<button id="upper">ᵁ</button>
<button id="squareBox">🅂</button>
<button id="squareFill">🆀</button>
<button id="round">Ⓡ</button>
<button id="typewrighter">𝚃</button>
<button id="wide">𝕎</button>

<div id="status" style="
  position: absolute;
  right: 1em;
  top: 0;"></div>
</div>
<script>
// @ts-check

function load() {

  var save_timeout;
  var selection_timeout;
  
  var textarea = /** @type {HTMLTextAreaElement} */(document.getElementById('textarea'));
  textarea.value = getStorageText();

  var status = document.getElementById('status');

  textarea.onchange = textarea_onchange;
  textarea.onselect = textarea_onselectionchange;
  textarea.onselectionchange = textarea_onselectionchange;
  textarea.onselectstart = textarea_onselectionchange;
  textarea.onkeydown = textarea_onselectionchange;
  textarea.onkeyup = textarea_onselectionchange;
  textarea.onmousedown = textarea_onselectionchange;

  window.onunload = window_onunload;

  addButtonHandlers();
  textarea_onselectionchange();

  function addButtonHandlers() {
    var buttonsArray = document.getElementsByTagName('button');
    for (var i = 0; i < buttonsArray.length; i++) {
      addHandler(buttonsArray[i]);
    }

    function addHandler(btn) {
      btn.onmousedown = btn_onmousedown;
      btn.onmouseup = btn_mouseup;
      btn.onclick = btn_click;

      function btn_onmousedown(evt) {
        if (evt.preventDefault) evt.preventDefault();
        // TODO: apply 
      }

      function btn_mouseup(evt) {
        if (evt.preventDefault) evt.preventDefault();
      }

      function btn_click(evt) {
        if (evt.preventDefault) evt.preventDefault();
      }
    }
  }

  function getStorageText() {
    try {
      return localStorage.getItem('tty.wtf.content');
    } catch (error) {
      console.log('Browser failed to get data from localStorage. ', error);
    }
  }

  function setStorageText(text) {
    try {
      localStorage.setItem('tty.wtf.content', text);
      setStorageText.lastStorageSuccess = true;
    } catch (error) {
      if (setStorageText.lastStorageSuccess !== true)
        console.log('Browser failed to store data into localStorage. ', error);
      setStorageText.lastStorageSuccess = false;
    }
  }

  function textarea_onchange() {
    clearTimeout(save_timeout);
    save_timeout = setTimeout(textarea_onchange_debounced, 600);
  }

  function textarea_onchange_debounced() {
    setStorageText(textarea.value);
    textarea_onselectionchange_debounced();
  }

  function textarea_onselectionchange() {
    clearTimeout(selection_timeout);
    selection_timeout = setTimeout(textarea_onselectionchange_debounced, 100);
  }

  function textarea_onselectionchange_debounced() {
    // TODO: detect selection and update font toolbar
    status.textContent = status.innerText = textarea.selectionStart + ':' + (textarea.selectionEnd - textarea.selectionStart);
  }

  function window_onunload() {
    // save to local storage NOW
    textarea_onchange_debounced();
  }
}
window.onload = load;
</script>
</body>
</html>