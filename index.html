<!DOCTYPE html>
<html lang="en" style="width: 100%; height: 100%; overflow: hidden; padding: 0; margin: 0;">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>TTY</title>
</head>
<body style="width: 100%; height: 100%; overflow: hidden; padding: 0; margin: 0;">
<textarea id="textarea" style="width: 100%; height: 100%; overflow: auto; border: none; padding: 1em; outline: none; font: inherit;">
</textarea>
<script>
// @ts-check

function load() {

  var save_timeout;
  var selection_timeout;
  
  var textarea = /** @type {HTMLTextAreaElement} */(document.getElementById('textarea'));
  textarea.value = getStorageText();

  textarea.onchange = textarea_onchange;
  textarea.onselect = textarea_selectionchange;
  textarea.onselectionchange = textarea_selectionchange;
  textarea.onselectstart = textarea_selectionchange;


  function getStorageText() {
    try {
      return localStorage.getItem('tty.wtf.content');
    } catch (error) {
      console.log('Browser failed to get data from localStorage. ', error);
    }
  }

  function setStorageText(text) {
    try {
      localStorage.setItem('tty.wtf.content', text);
      setStorageText.lastStorageSuccess = true;
    } catch (error) {
      if (setStorageText.lastStorageSuccess !== true)
        console.log('Browser failed to store data into localStorage. ', error);
      setStorageText.lastStorageSuccess = false;
    }
  }

  function textarea_onchange() {
    clearTimeout(save_timeout);
    save_timeout = setTimeout(textarea_onchange_debounced, 600);
  }

  function textarea_onchange_debounced() {
    setStorageText(textarea.value);
  }

  function textarea_selectionchange() {
    clearTimeout(selection_timeout);
    selection_timeout = setTimeout(textarea_selectionchange_debounced, 300);
  }

  function textarea_selectionchange_debounced() {
    // TODO: detect selection and update font toolbar
  }
}
window.onload = load;
</script>
</body>
</html>