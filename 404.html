<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TTY</title>
<style>
html {
  box-sizing: border-box;
  width: 100%; height: 100%;
  overflow: hidden;
  padding: 0; margin: 0;
}
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
  width: 100%; height: 100%;
  overflow: hidden;
  padding: 0; margin: 0;
}
*, *:before, *:after {
  box-sizing: inherit;
}

#toolbar {
  position: absolute;
  top: 0; left: 0; width: 100%;
  background-image: linear-gradient(to top, #fff6f6, white 1em);
  border-bottom: solid 1px #ffe6e6;
  padding-left: 0.3em;
}

#toolbar button {
  width: 2.7em; height: 2.7em; margin: 0.15em;
}

#textarea {
  position: absolute;
  top: 0; left: 0; width: 100%; height: 100%;
  overflow: auto;
  border: none;
  padding: 1em;
  outline: none;
  font: inherit;
  padding-top: 4em;
}

</style>
</head>
<body>
<textarea id="textarea" autofocus>
</textarea>
<div id="toolbar">
<button id="bold">𝗕</button>
<button id="italic">𝘐</button>
<button id="fractur">𝕱</button>
<button id="cursive">𝓒</button>
<button id="upper">ᵁ</button>
<button id="squareBox">🅂</button>
<button id="squareFill">🆀</button>
<button id="round">Ⓡ</button>
<button id="typewrighter">𝚃</button>
<button id="wide">𝕎</button>

<div id="status" style="
  position: absolute;
  right: 1em;
  top: 0;"></div>
</div>
<script>
// @ts-check

function ttywtf() {

  var REGEX_anychar_unicode = /./ug;
  var REGEX_startsWithBold = /^bold/;

  var variants = {
    bold: {AZ:'𝗔𝗕𝗖𝗗𝗘𝗙𝗚𝗛𝗜𝗝𝗞𝗟𝗠𝗡𝗢𝗣𝗤𝗥𝗦𝗧𝗨𝗩𝗪𝗫𝗬𝗭', az:'𝗮𝗯𝗰𝗱𝗲𝗳𝗴𝗵𝗶𝗷𝗸𝗹𝗺𝗻𝗼𝗽𝗾𝗿𝘀𝘁𝘂𝘃𝘄𝘅𝘆𝘇', '09':'𝟬𝟭𝟮𝟯𝟰𝟱𝟲𝟳𝟴𝟵'},
    italic: {AZ:'𝘈𝘉𝘊𝘋𝘌𝘍𝘎𝘏𝘐𝘑𝘒𝘓𝘔𝘕𝘖𝘗𝘘𝘙𝘚𝘛𝘜𝘝𝘞𝘟𝘠𝘡', az:'𝘢𝘣𝘤𝘥𝘦𝘧𝘨𝘩𝘪𝘫𝘬𝘭𝘮𝘯𝘰𝘱𝘲𝘳𝘴𝘵𝘶𝘷𝘸𝘹𝘺𝘻'},
    bolditalic: {AZ:'𝘼𝘽𝘾𝘿𝙀𝙁𝙂𝙃𝙄𝙅𝙆𝙇𝙈𝙉𝙊𝙋𝙌𝙍𝙎𝙏𝙐𝙑𝙒𝙓𝙔𝙕', az:'𝙖𝙗𝙘𝙙𝙚𝙛𝙜𝙝𝙞𝙟𝙠𝙡𝙢𝙣𝙤𝙥𝙦𝙧𝙨𝙩𝙪𝙫𝙬𝙭𝙮𝙯'},
    fractur: {AB:'𝔄𝔅', C:'ℭ',DG:'𝔇𝔈𝔉𝔊', HI:'ℌℑ', JQ:'𝔍𝔎𝔏𝔐𝔑𝔒𝔓𝔔', R:'ℜ', SY:'𝔖𝔗𝔘𝔙𝔚𝔛𝔜', Z:'ℨ', az:'𝔞𝔟𝔠𝔡𝔢𝔣𝔤𝔥𝔦𝔧𝔨𝔩𝔪𝔫𝔬𝔭𝔮𝔯𝔰𝔱𝔲𝔳𝔴𝔵𝔶𝔷'},
    boldfractur: {AZ:'𝕬𝕭𝕮𝕯𝕰𝕱𝕲𝕳𝕴𝕵𝕶𝕷𝕸𝕹𝕺𝕻𝕼𝕽𝕾𝕿𝖀𝖁𝖂𝖃𝖄𝖅', az:'𝖆𝖇𝖈𝖉𝖊𝖋𝖌𝖍𝖎𝖏𝖐𝖑𝖒𝖓𝖔𝖕𝖖𝖗𝖘𝖙𝖚𝖛𝖜𝖝𝖞𝖟'},
    cursive: {AZ:'𝒜𝐵𝒞𝒟𝐸𝐹𝒢𝐻𝐼𝒥𝒦𝐿𝑀𝒩𝒪𝒫𝒬𝑅𝒮𝒯𝒰𝒱𝒲𝒳𝒴𝒵', az:'𝒶𝒷𝒸𝒹𝑒𝒻𝑔𝒽𝒾𝒿𝓀𝓁𝓂𝓃𝑜𝓅𝓆𝓇𝓈𝓉𝓊𝓋𝓌𝓍𝓎𝓏'},
    boldcursive: {AZ:'𝓐𝓑𝓒𝓓𝓔𝓕𝓖𝓗𝓘𝓙𝓚𝓛𝓜𝓝𝓞𝓟𝓠𝓡𝓢𝓣𝓤𝓥𝓦𝓧𝓨𝓩', az:'𝓪𝓫𝓬𝓭𝓮𝓯𝓰𝓱𝓲𝓳𝓴𝓵𝓶𝓷𝓸𝓹𝓺𝓻𝓼𝓽𝓾𝓿𝔀𝔁𝔂𝔃'},
    upper: {AP:'ᴬᴮᶜᴰᴱᶠᴳᴴᴵᴶᴷᴸᴹᴺᴼᴾ', Q:'ᴼ̴', RW:'ᴿˢᵀᵁⱽᵂ', ap:'ᵃᵇᶜᵈᵉᶠᵍʰⁱʲᵏˡᵐⁿᵒᵖ', q:'٩', rz: 'ʳˢᵗᵘᵛʷˣʸᶻ', '09': '⁰¹²³⁴⁵⁶⁷⁸⁹'},
    squareBox: {AZ:'🄰🄱🄲🄳🄴🄵🄶🄷🄸🄹🄺🄻🄼🄽🄾🄿🅀🅁🅂🅃🅄🅅🅆🅇🅈🅉'},
    squareFill: {AP:'🅰🅱🅲🅳🅴🅵🅶🅷🅸🅹🅺🅻🅼🅽🅾🅿🆀🆁🆂🆃🆄🆅🆆🆇🆈🆉'},
    round: {AZ:'ⒶⒷⒸⒹⒺⒻⒼⒽⒾⒿⓀⓁⓂⓃⓄⓅⓆⓇⓈⓉⓊⓋⓌⓍⓎⓏ', az:'ⓐⓑⓒⓓⓔⓕⓖⓗⓘⓙⓚⓛⓜⓝⓞⓟⓠⓡⓢⓣⓤⓥⓦⓧⓨⓩ', '09':'⓪①②③④⑤⑥⑦⑧⑨'},
    typewriter: {AZ:'𝙰𝙱𝙲𝙳𝙴𝙵𝙶𝙷𝙸𝙹𝙺𝙻𝙼𝙽𝙾𝙿𝚀𝚁𝚂𝚃𝚄𝚅𝚆𝚇𝚈𝚉', az:'𝚊𝚋𝚌𝚍𝚎𝚏𝚐𝚑𝚒𝚓𝚔𝚕𝚖𝚗𝚘𝚙𝚚𝚛𝚜𝚝𝚞𝚟𝚠𝚡𝚢𝚣', '09': '𝟶𝟷𝟸𝟹𝟺𝟻𝟼𝟽𝟾𝟿'},
    wide: {AZ:'𝔸𝔹ℂ𝔻𝔼𝔽𝔾ℍ𝕀𝕁𝕂𝕃𝕄ℕ𝕆ℙℚℝ𝕊𝕋𝕌𝕍𝕎𝕏𝕐ℤ', az:'𝕒𝕓𝕔𝕕𝕖𝕗𝕘𝕙𝕚𝕛𝕜𝕝𝕞𝕟𝕠𝕡𝕢𝕣𝕤𝕥𝕦𝕧𝕨𝕩𝕪𝕫', '09': '𝟘𝟙𝟚𝟛𝟜𝟝𝟞𝟟𝟠𝟡'}
  };

  var parseRanges = createParser();

  var save_timeout;
  var selection_timeout_slide;
  var selection_timeout_max;
  
  var textarea = /** @type {HTMLTextAreaElement} */(document.getElementById('textarea'));
  textarea.value = getStorageText();

  var status = document.getElementById('status');

  textarea.onchange = textarea_onchange;
  textarea.onselect = textarea_onselectionchange;
  textarea.onselectionchange = textarea_onselectionchange;
  textarea.onselectstart = textarea_onselectionchange;
  textarea.onkeydown = textarea_onselectionchange;
  textarea.onkeyup = textarea_onselectionchange;
  textarea.onmousedown = textarea_onselectionchange;
  textarea.onmouseup = textarea_onselectionchange;
  textarea.onmousemove = textarea_onselectionchange;

  window.onunload = window_onunload;

  addButtonHandlers();
  textarea_onselectionchange();

  function addButtonHandlers() {
    var buttonsArray = document.getElementsByTagName('button');
    for (var i = 0; i < buttonsArray.length; i++) {
      addHandler(buttonsArray[i]);
    }

    function addHandler(btn) {
      btn.onmousedown = btn_onmousedown;
      btn.onmouseup = btn_mouseup;
      btn.onclick = btn_click;

      function btn_onmousedown(evt) {
        if (evt.preventDefault) evt.preventDefault();
        // TODO: apply 
      }

      function btn_mouseup(evt) {
        if (evt.preventDefault) evt.preventDefault();
      }

      function btn_click(evt) {
        if (evt.preventDefault) evt.preventDefault();
      }
    }
  }

  function getStorageText() {
    try {
      return localStorage.getItem('tty.wtf.content');
    } catch (error) {
      console.log('Browser failed to get data from localStorage. ', error);
    }
  }

  function setStorageText(text) {
    try {
      localStorage.setItem('tty.wtf.content', text);
      /** @type {{lastStorageSuccess?: boolean}}*/(setStorageText).lastStorageSuccess = true;
    } catch (error) {
      if (/** @type {{lastStorageSuccess?: boolean}}*/(setStorageText).lastStorageSuccess !== true)
        console.log('Browser failed to store data into localStorage. ', error);
      /** @type {{lastStorageSuccess?: boolean}}*/(setStorageText).lastStorageSuccess = false;
    }
  }

  function textarea_onchange() {
    clearTimeout(save_timeout);
    save_timeout = setTimeout(textarea_onchange_debounced, 600);
  }

  function textarea_onchange_debounced() {
    setStorageText(textarea.value);
    textarea_onselectionchange_debounced();
  }

  function textarea_onselectionchange() {
    if (!selection_timeout_max) selection_timeout_max = setTimeout(textarea_onselectionchange_debounced, 200);
    clearTimeout(selection_timeout_slide);
    selection_timeout_slide = setTimeout(textarea_onselectionchange_debounced, 70);
  }

  function textarea_onselectionchange_debounced() {
    clearTimeout(selection_timeout_slide);
    clearTimeout(selection_timeout_max);
    selection_timeout_max = 0;

    status.textContent = status.innerText = textarea.selectionStart + ':' + (textarea.selectionEnd - textarea.selectionStart);
    var modTextSection = getModifiersTextSection(textarea.value, textarea.selectionStart, textarea.selectionEnd);
    console.log('modTextSection: ', modTextSection);

    var toggleButtons = document.querySelectorAll('#toolbar button');
    for (var i = 0; i < toggleButtons.length; i++) {
      var btn = /** @type {HTMLButtonElement} */(toggleButtons[i]);
      if (btn.id) {
        btn.style.background = modTextSection.parsed.modifiers.indexOf(btn.id) >=0 ? 'silver' : null;
      }
    }
  }

  function getModifiersTextSection(text, start, end) {
    var modText = text;
    if (start !== end) {
      modText = modText.slice(start, end);
      return { text: modText, start: start, end: end, parsed: parseRanges(modText) };
    }

    var consequentMatch = /\S*$/.exec(text.slice(0, start));
    var consequentEntryStart = start - (consequentMatch ? consequentMatch[0].length : 0);
    var parsed = consequentMatch && consequentMatch[0] && parseRanges(consequentMatch[0]);
    var consequentEntry = parsed && parsed.length && parsed[parsed.length -1];
    if (!consequentMatch || !consequentMatch[0]) {
      consequentMatch = /^\S*/.exec(text.slice(start));
      parsed = consequentMatch && parseRanges(consequentMatch[0]);
      consequentEntry = parsed && parsed.length && parsed[0];
    }

    if (consequentMatch && consequentMatch[0]) {
      if (consequentEntry) {
        parsed.length = 1;
        parsed.modifiers = typeof consequentEntry === 'string' ? [] : consequentEntry.modifiers;
        parsed.fullModifiers = typeof consequentEntry === 'string' ? '' : consequentEntry.fullModifiers;
        parsed[0] = consequentEntry;
      } else {
        parsed.length = 0;
        parsed.modifiers = [];
        parsed.fullModifiers = '';
      }

      return {
        text: typeof consequentEntry === 'string' ? consequentEntry : consequentEntry.uni,
        start: consequentEntryStart,
        end: consequentEntryStart + consequentEntry.length,
        parsed: parsed
      };
    }

    return { text: '', start: start, end: start, parsed: parseRanges('')};
  }

  function window_onunload() {
    // save to local storage NOW
    textarea_onchange_debounced();
  }

  function createParser() {
    /** @type {{ uni: string, ascii: string, modifiers: string[], fullModifiers: string }[]} */
    var lookupList = [];
    /** @type {{ [uni: string]: typeof lookupList[0] }} */
    var lookup = {};

    var modKindList = [];
    for (var modKind in variants) {
      var rangeMap = variants[modKind];
      if (!rangeMap || typeof rangeMap !== 'object') continue;

      var modifiers = modKind.indexOf('bold') ? [modKind] : ['bold', modKind.slice(4)];

      for (var rangeDesc in rangeMap) {
        var rangeChars = rangeMap[rangeDesc];
        if (!rangeChars || typeof rangeChars !== 'string') continue;

        var rangeCount = rangeDesc.length === 1 ? 1 : rangeDesc.charCodeAt(1) - rangeDesc.charCodeAt(0) + 1;
        var uniWidth = rangeChars.length / rangeCount;
        for (let i = 0; i < rangeCount; i++) {
          var ascii = String.fromCharCode(rangeDesc.charCodeAt(0) + i);
          var rangeCh = rangeChars.slice(i * uniWidth, (i + 1) * uniWidth);
          var entry = { uni: rangeCh, ascii: ascii, modifiers: modifiers, fullModifiers: modKind };
          lookupList.push(entry);
          lookup[entry.uni] = entry;
        }
      }
    }

    lookupList.sort(function (entry1, entry2) {
      return -(entry1.uni.length - entry2.uni.length);
    });

    var matchRegex = new RegExp(lookupList.map(function(entry) { return entry.uni.replace(/[#-.]|[[-^]|[?|{}]/g, '\\$&'); }).join('|'), 'g');

    return parser;

    function parser(text) {
      var result = /** @type {((typeof lookupList[0] & { length: number }) | string)[] & { modifiers: string[], fullModifiers: string } } */([]);
      result.modifiers = [];

      var modifierDict = {};

      matchRegex.lastIndex = 0;
      let index = 0;
      while (true) {
        var match = matchRegex.exec(text);
        if (!match) break;

        if (match.index > index) {
          result.push(text.slice(index, match.index));
        }

        var entry = lookup[match[0]];
        var prev = result.length && result[result.length - 1];

        if (prev && typeof prev !== 'string' && prev.fullModifiers === entry.fullModifiers) {
          prev.uni += entry.uni;
          prev.length += entry.uni.length;
          prev.ascii += entry.ascii;
        } else {
          result.push({
            uni: entry.uni,
            ascii: entry.ascii,
            modifiers: entry.modifiers,
            fullModifiers: entry.fullModifiers,
            length: entry.uni.length
          });

          for (var i = 0; i < entry.modifiers.length; i++) {
            var mod = entry.modifiers[i];
            if (!modifierDict[mod]) {
              modifierDict[mod] = true;
              result.modifiers.push(mod);
            }
          }
        }

        index = match.index + match[0].length;
      }

      if (index < text.length) {
        result.push(text.slice(index));
      }

      result.modifiers.sort();
      result.fullModifiers = modifiers.join('');

      return result;
    }
  }


  /** @param str {string} */
  function breakIntoChars(str) {
    /** @type {string[]} */
    var arr = [];
    str.replace(REGEX_anychar_unicode, function (ch) {
      arr.push(ch);
      return '';
    });
    return arr;
  }
}
window.onload = ttywtf;
</script>
</body>
</html>